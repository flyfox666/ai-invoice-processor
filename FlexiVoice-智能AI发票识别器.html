<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiVoice-æ™ºèƒ½AIå‘ç¥¨è¯†åˆ«å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ PDF.js åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
        }
        .form-input, .form-select {
            @apply w-full bg-slate-100 border-slate-300 rounded-md py-2 px-3 text-slate-700 transition-all duration-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
        }
        .form-label {
            @apply block text-sm font-medium text-slate-600 mb-1;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden-file-input, .hidden-canvas {
            display: none;
        }
        /* æ–°å¢ï¼šè‡ªå®šä¹‰æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-box {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- ç”¨äºPDFæ¸²æŸ“çš„éšè—Canvas -->
    <canvas id="pdf-render-canvas" class="hidden-canvas"></canvas>

    <!-- æ–°å¢ï¼šè‡ªå®šä¹‰æ¨¡æ€æ¡†/å¼¹çª— -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 modal-box transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">æç¤º</h3>
                <button id="modal-close-btn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <p id="modal-message" class="text-slate-600 mb-6"></p>
            <div class="text-right">
                <button id="modal-ok-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                    å¥½çš„
                </button>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 sm:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">FlexiVoice-æ™ºèƒ½AIå‘ç¥¨è¯†åˆ«å™¨</h1>
            <p class="mt-2 text-lg text-slate-600">é€‚é…å¤šç§å¤§æ¨¡å‹ï¼Œæ™ºèƒ½è¯†åˆ«PDFï¼Œä¼˜åŒ–æˆæœ¬ä¸æ•ˆç‡</p>
        </header>

        <div class="max-w-5xl mx-auto space-y-8">
            <!-- 1. AIæ¨¡å‹é…ç½® -->
            <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                <h2 class="text-xl font-semibold mb-4 text-slate-800">ç¬¬ä¸€æ­¥ï¼šé…ç½®AIæ¨¡å‹</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="api-provider-select" class="form-label">API æœåŠ¡å•†</label>
                        <select id="api-provider-select" class="form-select"></select>
                        <input type="text" id="custom-api-base-url" class="form-input mt-2 hidden" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ API Base URL">
                    </div>
                     <div>
                        <label for="api-key" class="form-label">API Key</label>
                        <input type="password" id="api-key" class="form-input" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥">
                    </div>
                    <div>
                        <label for="text-model-select" class="form-label">æ–‡æœ¬æ¨¡å‹åç§°</label>
                        <select id="text-model-select" class="form-select"></select>
                        <input type="text" id="custom-text-model" class="form-input mt-2 hidden" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ–‡æœ¬æ¨¡å‹åç§°">
                    </div>
                    <div>
                        <label for="vision-model-select" class="form-label">è§†è§‰æ¨¡å‹åç§°</label>
                        <select id="vision-model-select" class="form-select"></select>
                        <input type="text" id="custom-vision-model" class="form-input mt-2 hidden" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰è§†è§‰æ¨¡å‹åç§°">
                    </div>
                </div>
                <div class="mt-4 p-3 bg-amber-100 text-amber-800 text-sm rounded-lg">
                    <p><strong>å®‰å…¨æç¤ºï¼š</strong> è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„APIå¯†é’¥ã€‚æ­¤é¡µé¢ä¸ä¼šå­˜å‚¨æ‚¨çš„å¯†é’¥ï¼Œä»…åœ¨æµè§ˆå™¨ä¸­ç”¨äºæœ¬æ¬¡è¯·æ±‚ã€‚</p>
                    <p class="mt-2"><strong>æ¨¡å‹æç¤ºï¼š</strong> å¯ä½¿ç”¨æ‰€æœ‰é€‚é…openai apiæ ¼å¼çš„æ¨¡å‹è°ƒç”¨ï¼Œæ¯”å¦‚ï¼šç«å±±å¤§æ¨¡å‹ã€æ™ºè°±ã€é˜¿é‡Œqwenç­‰ã€‚</p>
                </div>
            </div>

            <!-- 2. ä¸Šä¼ å‘ç¥¨ -->
            <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                <h2 class="text-xl font-semibold mb-4 text-slate-800">ç¬¬äºŒæ­¥ï¼šä¸Šä¼ å‘ç¥¨æ–‡ä»¶</h2>
                <div class="flex flex-col items-center">
                    <input type="file" id="file-upload" class="hidden-file-input" accept="image/png, image/jpeg, application/pdf" multiple>
                    <label for="file-upload" class="w-full md:w-auto text-center px-6 py-3 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 hover:border-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mx-auto text-slate-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span class="text-blue-600 font-medium">ç‚¹å‡»ä¸Šä¼ </span>
                        <span class="text-slate-500"> æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</span>
                        <p class="text-xs text-slate-400 mt-1">æ”¯æŒPNG, JPG, PDFæ ¼å¼</p>
                    </label>
                </div>
                <div id="file-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto"></div>
                <div id="file-actions" class="mt-4 flex items-center justify-center space-x-4">
                    <label for="file-upload" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer hover:bg-blue-600 transition-colors">
                        æ·»åŠ æ–°é™„ä»¶
                    </label>
                    <button id="clear-files-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                        æ¸…ç©ºé™„ä»¶
                    </button>
                </div>
            </div>

            <!-- 3. æ‰§è¡Œä¸ç»“æœ -->
            <div class="text-center">
                 <div class="flex items-center justify-center mb-4">
                    <input type="checkbox" id="force-vision-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                    <label for="force-vision-checkbox" class="ml-2 block text-sm text-slate-700">å¯¹æ‰€æœ‰PDFå¼ºåˆ¶ä½¿ç”¨è§†è§‰æ¨¡å‹ (è¯†åˆ«æ›´å‡†ï¼Œæˆæœ¬æ›´é«˜)</label>
                </div>
                 <button id="process-btn" class="w-full md:w-1/2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-transform transform active:scale-95 duration-200 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="btn-text">ğŸš€ å¼€å§‹æ™ºèƒ½è¯†åˆ«</span>
                </button>
            </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div id="results-container" class="hidden bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">è¯†åˆ«ç»“æœ</h2>
                    <button id="export-csv-btn" class="hidden bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        å¯¼å‡ºä¸ºCSV
                    </button>
                </div>
                <div id="status-area" class="text-center mb-4"></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">æºæ–‡ä»¶</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">å¤„ç†æ–¹å¼</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">å‘ç¥¨ç±»å‹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">å‘ç¥¨å·ç </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">å¼€ç¥¨æ—¥æœŸ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">é”€å”®æ–¹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">è´­ä¹°æ–¹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">é‡‘é¢</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ç¨é¢</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ä»·ç¨åˆè®¡</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- ç»“æœå°†åŠ¨æ€æ’å…¥æ­¤å¤„ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>&copy; 2024 Universal AI Invoice Processor</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- PDF.js Worker å’Œ cMap é…ç½® ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
        const CMAP_URL = 'https://unpkg.com/pdfjs-dist@2.16.105/cmaps/';


        // --- DOM å…ƒç´ è·å– ---
        const apiKeyInput = document.getElementById('api-key');
        const fileUploadInput = document.getElementById('file-upload');
        const fileListContainer = document.getElementById('file-list');
        const clearFilesBtn = document.getElementById('clear-files-btn');
        const processBtn = document.getElementById('process-btn');
        const btnText = document.getElementById('btn-text');
        const resultsContainer = document.getElementById('results-container');
        const statusArea = document.getElementById('status-area');
        const resultsTableBody = document.getElementById('results-table-body');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const forceVisionCheckbox = document.getElementById('force-vision-checkbox');
        const providerSelect = document.getElementById('api-provider-select');
        const customApiBaseUrlInput = document.getElementById('custom-api-base-url');
        const textModelSelect = document.getElementById('text-model-select');
        const customTextModelInput = document.getElementById('custom-text-model');
        const visionModelSelect = document.getElementById('vision-model-select');
        const customVisionModelInput = document.getElementById('custom-vision-model');

        // æ–°å¢ï¼šæ¨¡æ€æ¡†å…ƒç´ 
        const modal = document.getElementById('custom-modal');
        const modalBox = modal.querySelector('.modal-box');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        let selectedFiles = [];

        // --- æ¨¡å‹æ•°æ®é…ç½® ---
        const modelProviders = {
            'https://ark.cn-beijing.volces.com/api/v3': {
                label: 'å­—èŠ‚ç«å±±',
                textModels: ['deepseek-v3-1-250821', 'doubao-1-5-lite-32k-250115'],
                visionModels: ['doubao-seed-1-6-flash-250715']
            },
            'https://open.bigmodel.cn/api/paas/v4': {
                label: 'æ™ºè°±',
                textModels: ['glm-4.5-flash'],
                visionModels: ['glm-4.5v']
            }
        };

        // --- åˆå§‹åŒ–å’Œäº‹ä»¶ç›‘å¬ ---
        function initializeUI() {
            Object.entries(modelProviders).forEach(([url, {label}]) => {
                const option = new Option(label, url);
                providerSelect.add(option);
            });
            providerSelect.add(new Option('å…¶ä»–', 'other'));
            updateModelDropdowns(providerSelect.value);
            providerSelect.addEventListener('change', handleProviderChange);
            textModelSelect.addEventListener('change', () => toggleCustomInput(textModelSelect, customTextModelInput));
            visionModelSelect.addEventListener('change', () => toggleCustomInput(visionModelSelect, customVisionModelInput));
            fileUploadInput.addEventListener('change', handleFileSelection);
            clearFilesBtn.addEventListener('click', clearAllFiles);
            processBtn.addEventListener('click', processInvoices);
            exportCsvBtn.addEventListener('click', exportTableToCSV);
            
            // æ–°å¢ï¼šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶
            modalCloseBtn.addEventListener('click', hideModal);
            modalOkBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal();
                }
            });
        }
        function handleProviderChange() {
            const selectedProvider = providerSelect.value;
            toggleCustomInput(providerSelect, customApiBaseUrlInput);
            updateModelDropdowns(selectedProvider);
        }
        function updateModelDropdowns(providerUrl) {
            const provider = modelProviders[providerUrl];
            populateDropdown(textModelSelect, provider ? provider.textModels : []);
            populateDropdown(visionModelSelect, provider ? provider.visionModels : []);
            toggleCustomInput(textModelSelect, customTextModelInput);
            toggleCustomInput(visionModelSelect, customVisionModelInput);
        }
        function populateDropdown(selectElement, options) {
            selectElement.innerHTML = '';
            options.forEach(optionValue => {
                selectElement.add(new Option(optionValue, optionValue));
            });
            selectElement.add(new Option('å…¶ä»–', 'other'));
        }
        function toggleCustomInput(selectElement, inputElement) {
            if (selectElement.value === 'other') {
                inputElement.classList.remove('hidden');
            } else {
                inputElement.classList.add('hidden');
            }
        }
        function getSelectedValue(selectElement, inputElement) {
            return selectElement.value === 'other' ? inputElement.value.trim() : selectElement.value;
        }
        initializeUI();
        function handleFileSelection(event) {
            const newFiles = Array.from(event.target.files);
            if (newFiles.length > 0) {
                selectedFiles.push(...newFiles);
                updateFileListUI();
            }
            event.target.value = null; 
        }
        function updateFileListUI() {
            fileListContainer.innerHTML = '';
            if (selectedFiles.length > 0) {
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between p-2 rounded-md bg-slate-100';
                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.className = 'text-sm text-slate-700 truncate';
                    fileNameSpan.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700 font-bold text-lg px-2';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.dataset.index = index;
                    deleteBtn.onclick = deleteFile;
                    fileItem.appendChild(fileNameSpan);
                    fileItem.appendChild(deleteBtn);
                    fileListContainer.appendChild(fileItem);
                });
            }
        }
        function deleteFile(event) {
            const indexToDelete = parseInt(event.target.dataset.index, 10);
            selectedFiles.splice(indexToDelete, 1);
            updateFileListUI();
        }
        function clearAllFiles() {
            selectedFiles = [];
            updateFileListUI();
            resultsContainer.classList.add('hidden');
            exportCsvBtn.classList.add('hidden');
        }

        // --- æ ¸å¿ƒå¤„ç†é€»è¾‘ ---
        async function processInvoices() {
            const baseUrl = getSelectedValue(providerSelect, customApiBaseUrlInput);
            const apiKey = apiKeyInput.value.trim();
            const textModel = getSelectedValue(textModelSelect, customTextModelInput);
            const visionModel = getSelectedValue(visionModelSelect, customVisionModelInput);
            const forceVision = forceVisionCheckbox.checked;

            if (!baseUrl || !apiKey || !textModel || !visionModel) {
                showModal('è¯·å¡«å†™æ‰€æœ‰AIæ¨¡å‹é…ç½®é¡¹ã€‚');
                return;
            }
            if (selectedFiles.length === 0) {
                showModal('è¯·è‡³å°‘ä¸Šä¼ ä¸€ä¸ªå‘ç¥¨æ–‡ä»¶ã€‚');
                return;
            }

            setLoadingState(true);
            resultsContainer.classList.remove('hidden');
            exportCsvBtn.classList.add('hidden');
            resultsTableBody.innerHTML = '';
            
            let successCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                statusArea.innerHTML = `<div class="flex items-center justify-center"><div class="loader"></div><span class="ml-2">æ­£åœ¨å¤„ç†ç¬¬ ${i + 1} / ${selectedFiles.length} ä¸ªæ–‡ä»¶: ${file.name}</span></div>`;
                
                try {
                    const result = await processSingleFile(file, baseUrl, apiKey, textModel, visionModel, forceVision);
                    addResultToTable(result);
                    if (!result.error) {
                        successCount++;
                    }
                } catch (error) {
                    console.error(`å¤„ç†æ–‡ä»¶ ${file.name} æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:`, error);
                    addResultToTable({ fileName: file.name, error: error.message, processingMethod: 'é”™è¯¯' });
                }
            }
            
            statusArea.innerHTML = `<div class="p-3 bg-green-100 text-green-800 rounded-lg">å¤„ç†å®Œæˆï¼æˆåŠŸè¯†åˆ« ${successCount} ä¸ªæ–‡ä»¶ï¼Œå¤±è´¥ ${selectedFiles.length - successCount} ä¸ªã€‚</div>`;
            if (resultsTableBody.rows.length > 0) {
                exportCsvBtn.classList.remove('hidden');
            }
            setLoadingState(false);
        }

        async function processSingleFile(file, baseUrl, apiKey, textModel, visionModel, forceVision) {
            if (file.type.startsWith('image/')) {
                return await processImageFile(file, baseUrl, apiKey, visionModel);
            } else if (file.type === 'application/pdf') {
                return await processPdfFile(file, baseUrl, apiKey, textModel, visionModel, forceVision);
            } else {
                throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
            }
        }

        async function processImageFile(file, baseUrl, apiKey, visionModel) {
            const imageDataUrl = await renderImageToDataUrl(file);
            const prompt = getPromptForVision();
            const payload = {
                model: visionModel,
                messages: [{
                    role: "user",
                    content: [
                        { type: "text", text: prompt },
                        { type: "image_url", image_url: { url: imageDataUrl } }
                    ]
                }]
            };
            const result = await callApi(payload, baseUrl, apiKey);
            result.processingMethod = 'è§†è§‰æ¨¡å‹';
            return result;
        }

        // --- PDFå¤„ç†é€»è¾‘é‡æ„ ---
        async function processPdfFile(file, baseUrl, apiKey, textModel, visionModel, forceVision) {
            const pdfDoc = await loadPdfDocument(file);

            let textResult = null;
            if (!forceVision) {
                try {
                    const extractedText = await getTextFromPdf(pdfDoc);
                    const chineseCharCount = countChineseChars(extractedText);
                    
                    if (chineseCharCount > 15) { 
                        console.log(`æ–‡ä»¶ ${file.name} å°†ä½¿ç”¨æ–‡æœ¬æ¨¡å‹è¿›è¡Œå¤„ç†ã€‚`);
                        const prompt = getPromptForText();
                        const payload = {
                            model: textModel,
                            messages: [{ role: "user", content: `${prompt}\n\nä»¥ä¸‹æ˜¯ä»PDFä¸­æå–çš„æ–‡æœ¬å†…å®¹ï¼š\n\n${extractedText}` }]
                        };
                        textResult = await callApi(payload, baseUrl, apiKey);
                        
                        if (textResult.data && (textResult.data.invoiceNumber && textResult.data.invoiceNumber !== 'N/A') && (textResult.data.totalAmount && textResult.data.totalAmount !== 'N/A')) {
                            textResult.processingMethod = 'æ–‡æœ¬æ¨¡å‹';
                            return textResult;
                        } else {
                             console.warn(`æ–‡æœ¬æ¨¡å‹å¤„ç† ${file.name} å¤±è´¥ (å…³é”®ä¿¡æ¯ä¸ºN/A)ï¼Œå°†å¼ºåˆ¶ä½¿ç”¨è§†è§‰æ¨¡å‹é‡è¯•...`);
                        }
                    }
                } catch (textError) {
                    console.warn(`ä» ${file.name} æå–æ–‡æœ¬å¤±è´¥ï¼Œå°†å°è¯•å›¾ç‰‡è¯†åˆ«ã€‚é”™è¯¯:`, textError);
                }
            }

            const visionResult = await processPdfAsImage(pdfDoc, baseUrl, apiKey, visionModel);
            if (textResult) {
                visionResult.processingMethod = 'æ–‡æœ¬é‡è¯•(è§†è§‰)';
            } else {
                visionResult.processingMethod = forceVision ? 'å¼ºåˆ¶æ‰«æPDF' : 'æ‰«æPDF';
            }
            return visionResult;
        }
        
        async function processPdfAsImage(pdfDoc, baseUrl, apiKey, visionModel) {
             console.log(`æ–‡ä»¶ ${pdfDoc.fingerprint} å°†ä½œä¸ºå›¾ç‰‡ä½¿ç”¨è§†è§‰æ¨¡å‹è¿›è¡Œå¤„ç†ã€‚`);
            const imageDataUrl = await renderPdfToPngDataUrl(pdfDoc);
            const prompt = getPromptForVision();
            const payload = {
                model: visionModel,
                messages: [{
                    role: "user",
                    content: [
                        { type: "text", text: prompt },
                        { type: "image_url", image_url: { url: imageDataUrl } }
                    ]
                }]
            };
            return await callApi(payload, baseUrl, apiKey);
        }

        // --- è¾…åŠ©å‡½æ•° (é‡æ„ä¸ä¼˜åŒ–) ---
        async function loadPdfDocument(file) {
            const arrayBuffer = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({
                data: arrayBuffer,
                cMapUrl: CMAP_URL,
                cMapPacked: true,
            });
            return await loadingTask.promise;
        }

        async function getTextFromPdf(pdfDoc) {
            let fullText = '';
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ');
            }
            return fullText;
        }
        
        function countChineseChars(text) {
            if (!text) return 0;
            const match = text.match(/[\u4e00-\u9fa5]/g);
            return match ? match.length : 0;
        }

        async function renderPdfToPngDataUrl(pdfDoc) {
            const page = await pdfDoc.getPage(1);
            const viewport = page.getViewport({ scale: 3.0 }); 
            
            const canvas = document.getElementById('pdf-render-canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            
            return canvas.toDataURL('image/png');
        }
        
        async function renderImageToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function parseAmount(amountStr) {
            if (typeof amountStr !== 'string' || !amountStr) {
                return 0;
            }
            // ç§»é™¤éæ•°å­—ã€éå°æ•°ç‚¹ã€éè´Ÿå·çš„å­—ç¬¦
            const cleanedStr = amountStr.replace(/[^\d.-]/g, '');
            const number = parseFloat(cleanedStr);
            return isNaN(number) ? 0 : number;
        }
        
        async function callApi(payload, baseUrl, apiKey) {
            const apiUrl = `${baseUrl}/chat/completions`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                console.log(`API Response from ${payload.model}:`, JSON.stringify(result, null, 2));

                if (!response.ok || (result && !result.choices)) {
                     const errorMsg = result.error?.message || result.msg || JSON.stringify(result);
                     throw new Error(`APIå“åº”æ— æ•ˆæˆ–åŒ…å«é”™è¯¯: ${errorMsg}`);
                }
                const content = result.choices?.[0]?.message?.content;
                if (!content) {
                    throw new Error('APIå“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆå†…å®¹ã€‚');
                }
                const firstBrace = content.indexOf('{');
                const lastBrace = content.lastIndexOf('}');
                if (firstBrace === -1 || lastBrace === -1 || lastBrace < firstBrace) {
                    throw new Error('åœ¨æ¨¡å‹å“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå¯¹è±¡ã€‚');
                }
                const jsonString = content.substring(firstBrace, lastBrace + 1);
                const data = JSON.parse(jsonString);

                // --- æ–°å¢ï¼šç¨é¢è‡ªåŠ¨æ ¡å‡†é€»è¾‘ ---
                const preTaxAmount = parseAmount(data.preTaxAmount);
                const totalAmount = parseAmount(data.totalAmount);
                const taxAmount = parseAmount(data.taxAmount);

                // åˆ¤æ–­æ¡ä»¶ï¼šä»·ç¨åˆè®¡ > é‡‘é¢ï¼Œå¹¶ä¸”ç¨é¢ä¸º0æˆ–æ— æ•ˆ
                if (totalAmount > preTaxAmount && taxAmount === 0) {
                    const calculatedTax = totalAmount - preTaxAmount;
                    // é¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
                    if (Math.abs(calculatedTax) > 0.001) {
                        console.log(`æ£€æµ‹åˆ°å¼‚å¸¸ç¨é¢ï¼Œè‡ªåŠ¨æ ¡å‡†ã€‚æ–‡ä»¶å: ${selectedFiles[resultsTableBody.rows.length]?.name || 'N/A'}, åŸç¨é¢: ${data.taxAmount}, æ–°ç¨é¢: ${calculatedTax.toFixed(2)}`);
                        data.taxAmount = calculatedTax.toFixed(2);
                    }
                }
                // --- é€»è¾‘ç»“æŸ ---

                return { data };
            } catch (error) {
                 console.error(`è°ƒç”¨API (${payload.model}) æ—¶å‡ºé”™:`, error);
                 return { error: error.message };
            }
        }

        function addResultToTable(result) {
            const row = document.createElement('tr');
            const fileName = result.fileName || selectedFiles[resultsTableBody.rows.length].name;
            
            let methodBadge = '';
            switch(result.processingMethod) {
                case 'è§†è§‰æ¨¡å‹':
                    methodBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${result.processingMethod}</span>`;
                    break;
                case 'æ–‡æœ¬æ¨¡å‹':
                    methodBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${result.processingMethod}</span>`;
                    break;
                case 'æ‰«æPDF':
                     methodBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${result.processingMethod}</span>`;
                    break;
                case 'å¼ºåˆ¶æ‰«æPDF':
                     methodBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">${result.processingMethod}</span>`;
                    break;
                case 'æ–‡æœ¬é‡è¯•(è§†è§‰)':
                     methodBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">${result.processingMethod}</span>`;
                    break;
                default:
                    methodBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">å¤„ç†å¤±è´¥</span>`;
            }

            if (result.error) {
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${fileName}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${methodBadge}</td>
                    <td colspan="8" class="px-4 py-3 text-sm text-red-600">å¤±è´¥: ${result.error.substring(0, 100)}...</td>
                `;
                row.classList.add('bg-red-50');
            } else {
                const d = result.data;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${fileName}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${methodBadge}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.invoiceType || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.invoiceNumber || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.date || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.sellerName || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.buyerName || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.preTaxAmount || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.taxAmount || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${d.totalAmount || 'N/A'}</td>
                `;
            }
            resultsTableBody.appendChild(row);
        }

        function exportTableToCSV() {
            const table = document.querySelector("#results-container table");
            let csv = [];
            const rows = table.querySelectorAll("tr");
            for (const row of rows) {
                const cols = row.querySelectorAll("td, th");
                const rowData = [];
                for (const col of cols) {
                    let data = col.innerText.replace(/"/g, '""');
                    if (data.includes(',')) data = `"${data}"`;
                    rowData.push(data);
                }
                csv.push(rowData.join(','));
            }
            const csvFile = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
            const downloadLink = document.createElement("a");
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, "");
            downloadLink.download = `invoice_results_${timestamp}.csv`;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function setLoadingState(isLoading) {
            processBtn.disabled = isLoading;
            btnText.innerHTML = isLoading ? '<div class="loader mx-auto"></div>' : 'ğŸš€ å¼€å§‹æ™ºèƒ½è¯†åˆ«';
        }
        
        // --- æ–°å¢ï¼šè‡ªå®šä¹‰æ¨¡æ€æ¡†å‡½æ•° ---
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalBox.classList.remove('scale-95', 'opacity-0');
                modalBox.classList.add('scale-100');
            }, 10);
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            modalBox.classList.add('scale-95', 'opacity-0');
            modalBox.classList.remove('scale-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
        }

        // --- Promptæ¨¡æ¿ (å·²é’ˆå¯¹åˆè®¡é‡‘é¢å’Œç‰¹æ®Šç¨ç‡è¿›è¡Œæœ€ç»ˆä¼˜åŒ–) ---
        const basePrompt = `ä½ æ˜¯ä¸€ä½é¡¶çº§çš„ã€ç»éªŒä¸°å¯Œçš„è´¢åŠ¡ä¸“å®¶ï¼Œä½ çš„ä»»åŠ¡æ˜¯ä»å‘ç¥¨æ•°æ®ä¸­ç²¾å‡†åœ°æå–ç»“æ„åŒ–ä¿¡æ¯ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ï¼Œä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–markdownæ ‡è®°ã€‚

**æ ¸å¿ƒæŒ‡ä»¤ï¼š** ä½ çš„é¦–è¦ç›®æ ‡æ˜¯æ‰¾åˆ°å‘ç¥¨åº•éƒ¨çš„â€œåˆè®¡â€è¡Œï¼Œå¹¶ä»è¯¥è¡Œæå–æœ€ç»ˆçš„é‡‘é¢ã€ç¨é¢å’Œä»·ç¨åˆè®¡ã€‚å¿½ç•¥ä¸­é—´çš„å•†å“æˆ–æœåŠ¡æ˜ç»†è¡Œã€‚

1.  **å‘ç¥¨ç±»å‹ (invoiceType)**: 
    * åœ¨å‘ç¥¨æ ‡é¢˜ä¸­å¯»æ‰¾å…³é”®è¯ã€‚
    * å¦‚æœåŒ…å«â€œå¢å€¼ç¨ä¸“ç”¨å‘ç¥¨â€ï¼Œå€¼ä¸º "ä¸“ç”¨å‘ç¥¨"ã€‚
    * å¦‚æœåŒ…å«â€œå¢å€¼ç¨æ™®é€šå‘ç¥¨â€ï¼Œå€¼ä¸º "æ™®é€šå‘ç¥¨"ã€‚
    * å¦åˆ™ä¸º "å…¶ä»–"ã€‚

2.  **å‘ç¥¨å·ç  (invoiceNumber)**: 
    * å¯»æ‰¾â€œå‘ç¥¨å·ç â€è¿™å››ä¸ªæ±‰å­—ã€‚
    * æå–å…¶å³ä¾§æˆ–ä¸‹æ–¹çš„è¿ç»­æ•°å­—ä¸²ã€‚

3.  **å¼€ç¥¨æ—¥æœŸ (date)**: 
    * å¯»æ‰¾â€œå¼€ç¥¨æ—¥æœŸâ€æ ‡ç­¾ã€‚
    * æå–å…¶åçš„æ—¥æœŸï¼Œå¹¶ä¸¥æ ¼æ ¼å¼åŒ–ä¸º YYYY-MM-DDã€‚

4.  **è´­ä¹°æ–¹åç§° (buyerName)**:
    * **ä¸»è¦æ ‡å¿—**: é¦–å…ˆå®šä½åˆ°å…³é”®è¯â€œè´­ä¹°æ–¹â€æˆ–â€œè´­è´§å•ä½â€ã€‚
    * **å…³è”æå–**: åœ¨â€œè´­ä¹°æ–¹â€å…³é”®è¯ä¹‹åç´§é‚»çš„æ–‡æœ¬å—ä¸­ï¼Œæ‰¾åˆ°â€œåç§°â€æˆ–â€œå ç§°â€æ ‡ç­¾ï¼Œå¹¶æå–å…¶å¯¹åº”çš„å®Œæ•´å…¬å¸åç§°ã€‚
    * **éªŒè¯çº¿ç´¢**: åŒä¸€ä¸ªæ–‡æœ¬å—ä¸­é€šå¸¸ä¼šåŒ…å«è´­ä¹°æ–¹çš„â€œç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /çº³ç¨äººè¯†åˆ«å·â€ï¼Œå¯ç”¨äºéªŒè¯ã€‚å¦‚æœæ‰¾ä¸åˆ°â€œè´­ä¹°æ–¹â€å…³é”®è¯ï¼Œå†å°è¯•å¯»æ‰¾å¸ƒå±€ä¸Šä½äºå‘ç¥¨ä¸­ä¸Šéƒ¨æˆ–å·¦ä¾§åŒºåŸŸçš„â€œåç§°â€å­—æ®µã€‚

5.  **é”€å”®æ–¹åç§° (sellerName)**:
    * **ä¸»è¦æ ‡å¿—**: é¦–å…ˆå®šä½åˆ°å…³é”®è¯â€œé”€å”®æ–¹â€æˆ–â€œé”€è´§å•ä½â€ã€‚
    * **å…³è”æå–**: åœ¨â€œé”€å”®æ–¹â€å…³é”®è¯ä¹‹åç´§é‚»çš„æ–‡æœ¬å—ä¸­ï¼Œæ‰¾åˆ°â€œåç§°â€æˆ–â€œå ç§°â€æ ‡ç­¾ï¼Œå¹¶æå–å…¶å¯¹åº”çš„å®Œæ•´å…¬å¸åç§°ã€‚
    * **éªŒè¯çº¿ç´¢**: åŒä¸€ä¸ªæ–‡æœ¬å—ä¸­é€šå¸¸ä¼šåŒ…å«é”€å”®æ–¹çš„â€œç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /çº³ç¨äººè¯†åˆ«å·â€ä»¥åŠåœ°å€ã€ç”µè¯ã€å¼€æˆ·è¡Œç­‰ä¿¡æ¯ï¼Œå¯ç”¨äºéªŒè¯ã€‚å¦‚æœæ‰¾ä¸åˆ°â€œé”€å”®æ–¹â€å…³é”®è¯ï¼Œå†å°è¯•å¯»æ‰¾å¸ƒå±€ä¸Šä½äºå‘ç¥¨ä¸­ä¸‹éƒ¨æˆ–å³ä¾§åŒºåŸŸçš„â€œåç§°â€å­—æ®µã€‚

6.  **é‡‘é¢ (preTaxAmount)**: 
    * **å…³é”®æ­¥éª¤**: é¦–å…ˆå®šä½åˆ°æ˜ç¡®æ ‡æœ‰â€œåˆè®¡â€æˆ–â€œåˆ è®¡â€çš„è¡Œã€‚
    * åœ¨è¯¥â€œåˆè®¡â€è¡Œå†…ï¼ŒæŸ¥æ‰¾â€œé‡‘é¢â€åˆ—å¯¹åº”çš„æ•°å€¼ã€‚è¿™ä¸ªæ•°å€¼æ˜¯æ‰€æœ‰æ˜ç»†ï¼ˆåŒ…æ‹¬æ­£æ•°å’Œè´Ÿæ•°æŠ˜æ‰£ï¼‰è®¡ç®—åçš„æœ€ç»ˆç»“æœã€‚

7.  **ç¨é¢ (taxAmount)**: 
    * **å…³é”®æ­¥éª¤**: åŒæ ·åœ¨â€œåˆè®¡â€è¡Œå†…æŸ¥æ‰¾ã€‚
    * æŸ¥æ‰¾â€œç¨é¢â€åˆ—å¯¹åº”çš„æ•°å€¼ã€‚
    * **ç‰¹æ®Šæƒ…å†µå¤„ç†**: å¦‚æœåœ¨æ˜ç»†è¡Œæˆ–åˆè®¡è¡Œçš„â€œç¨ç‡â€æˆ–â€œç¨é¢â€åˆ—ä¸­çœ‹åˆ°æ˜Ÿå·â€œ*â€ã€æ¨ªçº¿â€œ-â€æˆ–å†…å®¹ä¸ºç©ºï¼Œè¿™ä»£è¡¨ç¨é¢æœªå•ç‹¬åˆ—å‡ºæˆ–ä¸ºé›¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥é¡¹çš„å€¼å¿…é¡»è®¾ä¸º "0.00" æˆ– "N/A"ã€‚ä¸è¦å°è¯•é€šè¿‡ä»·ç¨åˆè®¡å‡å»é‡‘é¢æ¥è®¡ç®—ã€‚

8.  **ä»·ç¨åˆè®¡(å°å†™) (totalAmount)**: 
    * **å…³é”®æ­¥éª¤**: åŒæ ·åœ¨â€œåˆè®¡â€è¡Œå†…æŸ¥æ‰¾ã€‚
    * æŸ¥æ‰¾â€œä»·ç¨åˆè®¡(å°å†™)â€ã€â€œ(å°å†™)â€æˆ–â€œæ€»è®¡â€æ ‡ç­¾å¯¹åº”çš„æœ€ç»ˆæ•°å€¼ã€‚è¿™é€šå¸¸æ˜¯å‘ç¥¨ä¸Šæœ€æ˜¾è‘—çš„æ€»é‡‘é¢ã€‚

è¯·ç¡®ä¿è¾“å‡ºçš„JSONå¯¹è±¡åŒ…å«ä»¥ä¸‹æ‰€æœ‰é”®: "invoiceType", "invoiceNumber", "date", "buyerName", "sellerName", "preTaxAmount", "taxAmount", "totalAmount"ã€‚å¦‚æœæŸé¡¹ä¿¡æ¯ç¡®å®æ— æ³•æ‰¾åˆ°ï¼Œè¯·å°†è¯¥é¡¹çš„å€¼è®¾ä¸º "N/A"ã€‚`;

        function getPromptForVision() {
            return basePrompt.replace(/å†…å®¹/g, 'å›¾ç‰‡');
        }

        function getPromptForText() {
            return basePrompt.replace(/å†…å®¹/g, 'æ–‡æœ¬');
        }

    });
    </script>
</body>
</html>
